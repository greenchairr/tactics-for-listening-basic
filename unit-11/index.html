<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unit 11: Entertainment - Practice</title>
    <style>
        :root { --primary: #2c3e50; --secondary: #3498db; --success: #27ae60; --danger: #e74c3c; --bg: #f0f2f5; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 0; display: flex; justify-content: center; }
        
        .container { width: 100%; max-width: 650px; background: white; min-height: 100vh; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        
        /* Tabs & Home Button */
        .tabs { display: flex; background: var(--primary); position: sticky; top: 0; z-index: 100; }
        .tab-btn { flex: 1; padding: 15px 5px; border: none; background: none; color: white; cursor: pointer; font-weight: bold; font-size: 0.85rem; transition: 0.3s; opacity: 0.6; text-align: center; }
        .tab-btn.active { opacity: 1; border-bottom: 4px solid var(--secondary); background: rgba(255,255,255,0.1); }
        .home-btn { flex: 0.6; background: rgba(0,0,0,0.3) !important; opacity: 1 !important; text-decoration: none; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.85rem; }

        .tab-content { display: none; padding: 20px; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Vocabulary & Listening UI */
        h2 { font-size: 1.1rem; color: var(--primary); border-left: 5px solid var(--secondary); padding-left: 10px; margin-bottom: 20px; }
        .item-row { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        input[type="text"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        .correct-ans { color: var(--danger); font-size: 0.9rem; font-weight: bold; display: none; margin-top: 5px; }
        .inline-ans { color: var(--danger); font-weight: bold; font-size: 0.9rem; display: none; margin-left: 5px; }

        .verify-btn { width: 100%; padding: 15px; border: none; border-radius: 10px; background: var(--success); color: white; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 1rem; }
        
        /* Speaking Section */
        .speaking-card { background: #f8fbff; border: 1px solid #e1e8f0; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .action-btns { display: flex; gap: 10px; margin-top: 12px; }
        .btn-action { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-tts { background: var(--secondary); }
        .btn-record { background: var(--danger); }
        .recording { animation: pulse 1.2s infinite; background: #c0392b !important; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 15px; background: #fff; }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <a href="../index.html" class="home-btn">üè† MENU</a>
        <button class="tab-btn active" onclick="openTab(event, 'part1')">1. VOCAB</button>
        <button class="tab-btn" onclick="openTab(event, 'part2')">2. LISTEN</button>
        <button class="tab-btn" onclick="openTab(event, 'part3')">3. SPEAK</button>
    </div>

    <div id="part1" class="tab-content active">
        <h2>Vocabulary Recall</h2>
        <div id="vocab-container"></div>
        <button class="verify-btn" onclick="verifyVocab()">VERIFY ANSWERS</button>
    </div>

    <div id="part2" class="tab-content">
        <h2>Listen and Fill in the Blanks</h2>
        <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
            <audio controls style="width: 100%;">
                <source src="unit11_audio.mp3" type="audio/mpeg">
                Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ audio.
            </audio>
        </div>
        <div id="listening-container" style="line-height: 2.2;"></div>
        <button class="verify-btn" onclick="verifyListen()">VERIFY ANSWERS</button>
    </div>

    <div id="part3" class="tab-content">
        <h2>Speaking Practice</h2>
        <div style="background: #eee; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
            <label style="font-size: 0.8rem; font-weight: bold;">AI Voice Selection:</label>
            <select id="voiceSelect"></select>
        </div>
        <div id="speaking-container"></div>
    </div>
</div>

<script>
    // --- DATA ---
    const vocabData = [
        { vn: "H√†nh ƒë·ªông", en: "action" }, { vn: "Tr∆∞·ª£t patin", en: "rollerblading" },
        { vn: "D√£ ngo·∫°i", en: "picnic" }, { vn: "C·ªët truy·ªán", en: "story" },
        { vn: "T·∫≠p th·ªÉ d·ª•c", en: "exercise" }, { vn: "Tr·∫≠n ƒë·∫•u", en: "game" },
        { vn: "ƒêi b∆°i", en: "swimming" }, { vn: "C√°t", en: "sand" },
        { vn: "Qu·∫ßn jeans", en: "jeans" }, { vn: "√Åo s∆° mi", en: "shirts" }
    ];

    const listenData = [
        "<b>D1:</b> The (1) [story] is great. It‚Äôs full of (2) [action].",
        "<b>D2:</b> Perfect for (3) [swimming]. Lie on the (4) [sand] and (5) [sleep].",
        "<b>D3:</b> What time is the (6) [game]? Are you (7) [playing]?",
        "<b>D4:</b> This (8) [weekend]? Let's go (9) [rollerblading].",
        "<b>D5:</b> I need some (10) [jeans] and (11) [shirts].",
        "<b>D6:</b> It's great (12) [exercise]. Have a (13) [picnic] in the park."
    ];

    const speakSentences = [
        "This weekend, I want to go swimming and watch an action movie.",
        "The story of this movie is great and it is full of action.",
        "I need to buy some new jeans and shirts on Saturday afternoon.",
        "Let's get the guys and go rollerblading in the park.",
        "It's great exercise, so maybe we can have a picnic there."
    ];

    // --- LOGIC ---
    function openTab(evt, tabName) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        if(evt.currentTarget.tagName === "BUTTON") evt.currentTarget.classList.add('active');
        window.scrollTo(0, 0);
    }

    // Load Part 1
    const vContainer = document.getElementById('vocab-container');
    vocabData.forEach((v, i) => {
        vContainer.innerHTML += `
            <div class="item-row">
                <span style="font-weight:600; display:block; margin-bottom:5px;">${i+1}. ${v.vn}</span>
                <input type="text" id="v-input-${i}" placeholder="English word...">
                <div class="correct-ans" id="v-ans-${i}">Correct: ${v.en}</div>
            </div>`;
    });

    // Load Part 2
    const lContainer = document.getElementById('listening-container');
    let qIdx = 1;
    listenData.forEach(text => {
        let processed = text.replace(/\[(.*?)\]/g, () => {
            let html = `<input type="text" id="q-input-${qIdx}" style="width:90px; height:30px;"> <span class="inline-ans" id="q-ans-${qIdx}"></span>`;
            qIdx++;
            return html;
        });
        lContainer.innerHTML += `<div style="margin-bottom:15px">${processed}</div>`;
    });

    // Load Part 3
    const sContainer = document.getElementById('speaking-container');
    speakSentences.forEach((s, i) => {
        sContainer.innerHTML += `
            <div class="speaking-card">
                <span id="txt-${i}" style="font-weight:500; display:block;">${s}</span>
                <div class="action-btns">
                    <button class="btn-action btn-tts" onclick="playTTS(${i})">üîä Listen</button>
                    <button class="btn-action btn-record" id="rec-${i}" onclick="toggleRecord(${i})">üé§ Record</button>
                </div>
                <audio id="playback-${i}" controls style="display:none; margin-top:10px;"></audio>
            </div>`;
    });

    // Verify Functions
    function verifyVocab() {
        vocabData.forEach((v, i) => {
            const input = document.getElementById(`v-input-${i}`);
            const ans = document.getElementById(`v-ans-${i}`);
            if(input.value.toLowerCase().trim() !== v.en) { ans.style.display = 'block'; input.style.borderColor = 'var(--danger)'; }
            else { ans.style.display = 'none'; input.style.borderColor = 'var(--success)'; }
        });
    }

    function verifyListen() {
        const answers = ["story", "action", "swimming", "sand", "sleep", "game", "playing", "weekend", "rollerblading", "jeans", "shirts", "exercise", "picnic"];
        answers.forEach((a, i) => {
            const id = i + 1;
            const input = document.getElementById(`q-input-${id}`);
            const ans = document.getElementById(`q-ans-${id}`);
            if(input.value.toLowerCase().trim() !== a) { ans.innerHTML = `(${a})`; ans.style.display = 'inline'; input.style.borderColor = 'var(--danger)'; }
            else { ans.style.display = 'none'; input.style.borderColor = 'var(--success)'; }
        });
    }

    // TTS & Voice Selector
    function populateVoices() {
        const voices = window.speechSynthesis.getVoices();
        const select = document.getElementById('voiceSelect');
        select.innerHTML = '';
        voices.filter(v => v.lang.includes('en')).forEach(v => {
            const opt = document.createElement('option');
            opt.value = v.name;
            opt.textContent = `${v.name} (${v.lang})`;
            if(v.name.includes('Google') || v.name.includes('Natural')) opt.selected = true;
            select.appendChild(opt);
        });
    }
    window.speechSynthesis.onvoiceschanged = populateVoices;
    populateVoices();

    function playTTS(id) {
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(document.getElementById(`txt-${id}`).innerText);
        msg.voice = window.speechSynthesis.getVoices().find(v => v.name === document.getElementById('voiceSelect').value);
        msg.rate = 0.85;
        window.speechSynthesis.speak(msg);
    }

    // Record Logic
    let mediaRecorder; let chunks = [];
    async function toggleRecord(id) {
        const btn = document.getElementById(`rec-${id}`);
        if(!mediaRecorder || mediaRecorder.state === 'inactive') {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            chunks = [];
            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'audio/wav' });
                document.getElementById(`playback-${id}`).src = URL.createObjectURL(blob);
                document.getElementById(`playback-${id}`).style.display = 'block';
            };
            mediaRecorder.start();
            btn.innerHTML = "Stop"; btn.classList.add('recording');
        } else {
            mediaRecorder.stop();
            btn.innerHTML = "Record"; btn.classList.remove('recording');
        }
    }
</script>

</body>
</html>
